<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">

<head>
  <title>Sudoku</title>
  
  <style type="text/css">
    table.frame {
      border-spacing: 0px;
      border-collapse: separate;
      border:2px solid black;
    }
    table.boxframe {
      border-spacing: 0px;
      border-collapse: separate;
      border:1px solid black;
    }
    table.bitcellframe {
      border-spacing: 0px;
      border-collapse: separate;
      border:0px;
    }
    td.box {padding:0; margin:0;}
    td.cell {
      padding:0;
      margin:0;
      border: 1px solid black;
      width: 51px;
      height: 53px;
      text-align: center;
      font-size: xx-large;
    }
    td.bitcell {
      padding:0;
      margin:0;
      border: 0px;
      width: 17px;
      height: 17px;
      text-align: center;
      font-size: small;
    }
    td.pad {
      background-color: #AAAAAA;
      font-size: xx-large;
    }
    td.pad2 {
      background-color: #AAAAAA;
      font-size: large;
    }
    td.pad3 {
      background-color: #55FF55;
      font-size: large;
    }
    td.pad4 {
      background-color: #FF5555;
      font-size: large;
    }
    td.pad5 {
      background-color: #5555FF;
      font-size: large;
    }
    td.button {
      padding:0;
      margin:0;
      border: 1px solid black;
      width: 206px;
      height: 45px;
      text-align: center;
      font-size: large;
    }
    td.button2 {
      width: 103px;
    }
  </style>

  <!--  tr {background-color:green;} -->
  <!--  td.box {border:2px solid blue;} -->
  <!--  table.frame {border-collapse: collapse;} -->
  <!--  table.boxframe {border:2px solid red;} -->

</head>

<body>

<table><tr>

<!-- 3box x 3box table -->
<td><table class="frame">
  <!-- First Row -->
  <tr>
    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell" id="c00"></td>
          <td class="cell" id="c01"></td>
          <td class="cell" id="c02"></td>
        </tr>
        <tr>
          <td class="cell" id="c09"></td>
          <td class="cell" id="c10"></td>
          <td class="cell" id="c11"></td>
        </tr>
        <tr>
          <td class="cell" id="c18"></td>
          <td class="cell" id="c19"></td>
          <td class="cell" id="c20"></td>
        </tr>
      </table>
    </td>

    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell" id="c03"></td>
          <td class="cell" id="c04"></td>
          <td class="cell" id="c05"></td>
        </tr>
        <tr>
          <td class="cell" id="c12"></td>
          <td class="cell" id="c13"></td>
          <td class="cell" id="c14"></td>
        </tr>
        <tr>
          <td class="cell" id="c21"></td>
          <td class="cell" id="c22"></td>
          <td class="cell" id="c23"></td>
        </tr>
      </table>
    </td>

    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell" id="c06"></td>
          <td class="cell" id="c07"></td>
          <td class="cell" id="c08"></td>
        </tr>
        <tr>
          <td class="cell" id="c15"></td>
          <td class="cell" id="c16"></td>
          <td class="cell" id="c17"></td>
        </tr>
        <tr>
          <td class="cell" id="c24"></td>
          <td class="cell" id="c25"></td>
          <td class="cell" id="c26"></td>
        </tr>
      </table>
    </td>
  </tr>

  <!-- Second Row -->
  <tr>
    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell" id="c27"></td>
          <td class="cell" id="c28"></td>
          <td class="cell" id="c29"></td>
        </tr>
        <tr>
          <td class="cell" id="c36"></td>
          <td class="cell" id="c37"></td>
          <td class="cell" id="c38"></td>
        </tr>
        <tr>
          <td class="cell" id="c45"></td>
          <td class="cell" id="c46"></td>
          <td class="cell" id="c47"></td>
        </tr>
      </table>
    </td>

    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell" id="c30"></td>
          <td class="cell" id="c31"></td>
          <td class="cell" id="c32"></td>
        </tr>
        <tr>
          <td class="cell" id="c39"></td>
          <td class="cell" id="c40"></td>
          <td class="cell" id="c41"></td>
        </tr>
        <tr>
          <td class="cell" id="c48"></td>
          <td class="cell" id="c49"></td>
          <td class="cell" id="c50"></td>
        </tr>
      </table>
    </td>

    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell" id="c33"></td>
          <td class="cell" id="c34"></td>
          <td class="cell" id="c35"></td>
        </tr>
        <tr>
          <td class="cell" id="c42"></td>
          <td class="cell" id="c43"></td>
          <td class="cell" id="c44"></td>
        </tr>
        <tr>
          <td class="cell" id="c51"></td>
          <td class="cell" id="c52"></td>
          <td class="cell" id="c53"></td>
        </tr>
      </table>
    </td>
  </tr>

  <!-- Third Row -->
  <tr>
    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell" id="c54"></td>
          <td class="cell" id="c55"></td>
          <td class="cell" id="c56"></td>
        </tr>
        <tr>
          <td class="cell" id="c63"></td>
          <td class="cell" id="c64"></td>
          <td class="cell" id="c65"></td>
        </tr>
        <tr>
          <td class="cell" id="c72"></td>
          <td class="cell" id="c73"></td>
          <td class="cell" id="c74"></td>
        </tr>
      </table>
    </td>

    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell" id="c57"></td>
          <td class="cell" id="c58"></td>
          <td class="cell" id="c59"></td>
        </tr>
        <tr>
          <td class="cell" id="c66"></td>
          <td class="cell" id="c67"></td>
          <td class="cell" id="c68"></td>
        </tr>
        <tr>
          <td class="cell" id="c75"></td>
          <td class="cell" id="c76"></td>
          <td class="cell" id="c77"></td>
        </tr>
      </table>
    </td>

    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell" id="c60"></td>
          <td class="cell" id="c61"></td>
          <td class="cell" id="c62"></td>
        </tr>
        <tr>
          <td class="cell" id="c69"></td>
          <td class="cell" id="c70"></td>
          <td class="cell" id="c71"></td>
        </tr>
        <tr>
          <td class="cell" id="c78"></td>
          <td class="cell" id="c79"></td>
          <td class="cell" id="c80"></td>
        </tr>
      </table>
    </td>
  </tr>
</table></td>

<!-- 3box x 3box table -->
<td><table class="frame">
  <!-- First Row -->
  <tr>
    <td class="box">
      <!-- 3x3 within-box table -->
      <table class="boxframe">
        <tr>
          <td class="cell pad" id="inp7">7</td>
          <td class="cell pad" id="inp8">8</td>
          <td class="cell pad" id="inp9">9</td>
          <td class="cell pad2" id="inpA">All</td>
        </tr>
        <tr>
          <td class="cell pad" id="inp4">4</td>
          <td class="cell pad" id="inp5">5</td>
          <td class="cell pad" id="inp6">6</td>
          <td class="cell pad2" id="inpC">Clear</td>
        </tr>
        <tr>
          <td class="cell pad" id="inp1">1</td>
          <td class="cell pad" id="inp2">2</td>
          <td class="cell pad" id="inp3">3</td>
          <td class="cell pad2" id="inpN"></td>
        </tr>
        <tr><td class="button pad3" id="actNew" colspan="4">Create New Puzzle</td></tr>
        <tr><td class="button pad2" id="actLvl" colspan="4">Toggle Level (<span id="level">Easy</span>)</td></tr>
        <tr><td class="button pad4" id="actSav" colspan="4">Save Position (<span id="position">1/1</span>)</td></tr>
        <tr>
          <td class="button button2 pad4" id="actPrv" colspan="2">&lt;</td>
          <td class="button button2 pad4" id="actNxt" colspan="2">&gt;</td>
        </tr>
        <tr><td class="button pad5" id="actSlv" colspan="4">Solve</td></tr>
        <tr><td class="button pad2" id="actClr" colspan="4">Clear Grid</td></tr>
        <tr><td class="button pad2" id="actFix" colspan="4">Fix/Unfix Grid</td></tr>
      </table>
    </td>
  </tr>

</table></td>

</tr></table>

<p id="validity"></p>
<p id="solved"></p>





</body>

<script type="text/javascript">

  // ---------------------------------------------------------------------------
  // Set up static global variables
  // ---------------------------------------------------------------------------

  var R = 0;
  var C = 1;
  var B = 2;

  var SETBIT       = 1;
  var UNSETBIT     = 2;
  var SETALLBITS   = 3;
  var UNSETALLBITS = 4;

  level_element = document.getElementById("level");
  position_element = document.getElementById("position");

</script>

<script src="Cell.js"></script>
<script src="Action.js"></script>
<script src="Grid.js"></script>
<script src="Step.js"></script>
<script src="History.js"></script>
<script src="Sudoku.js"></script>

<script type="text/javascript">

  // ---------------------------------------------------------------------------
  // Create new Sudoku object
  // ---------------------------------------------------------------------------

  var sudoku = new Sudoku();

  // ---------------------------------------------------------------------------
  // Handle key presses
  // ---------------------------------------------------------------------------

  window.addEventListener("keyup", function (event) {

    if (event.defaultPrevented) {
      return; // Do nothing if the event was already processed
    }

    if (sudoku.selection != -1) {
      // DEAL WITH SELECTION CASES

      var cell = sudoku.grid.getCellRef(sudoku.selection);

      switch (event.key.toUpperCase()) {

        case "ARROWUP":
          if (sudoku.selection > 8) {
            sudoku.selection -= 9;
          } else {
            sudoku.selection += 72;
          }
          sudoku.drawCell(sudoku.grid.getCellRef(sudoku.selection));
          break;

        case "ARROWDOWN":
          if (sudoku.selection < 72) {
            sudoku.selection += 9;
          } else {
            sudoku.selection -= 72;
          }
          sudoku.drawCell(sudoku.grid.getCellRef(sudoku.selection));
          break;

        case "ARROWLEFT":
          if (sudoku.selection % 9 != 0) {
            sudoku.selection += -1;
          } else {
            sudoku.selection += 8;
          }
          sudoku.drawCell(sudoku.grid.getCellRef(sudoku.selection));
          break;

        case "ARROWRIGHT":
          if (sudoku.selection % 9 != 8) {
            sudoku.selection++;
          } else {
            sudoku.selection -= 8;
          }
          sudoku.drawCell(sudoku.grid.getCellRef(sudoku.selection));
          break;

        case "SPACEBAR":
        case " ":
          if (!cell.isFixed()) {
            if (cell.isFinalised()) {
              cell.unfinaliseCell();
            } else if (cell.count() == 1) {
              cell.finaliseCell();
            }
          }
          break;

        case "1":
        case "2":
        case "3":
        case "4":
        case "5":
        case "6":
        case "7":
        case "8":
        case "9":
          cell.processBit(parseInt(event.key)-1);
          break;

        default:
          break;
      }

      sudoku.drawCell(cell);
      sudoku.reportValidity();
      sudoku.reportSolvedGrid();

    } else {
      // DEAL WITH NON-SELECTION CASES

    }

    // Cancel the default action to avoid it being handled twice
    event.preventDefault();
  }, true);
  // the last option dispatches the event to the listener first,
  // then dispatches event to window


  // ---------------------------------------------------------------------------
  // Set up handling of cell selections
  // ---------------------------------------------------------------------------

  for (var i = 0; i < 81; i++) {
    var id = '' + i;
    id = "c" + "00".substring(id.length) + id;

    document.getElementById(id).onclick = function() {
      var id = this.getAttribute("id");
      //var elem = document.getElementById(id);
      var selection = parseInt(id.substr(1));

      var cell = sudoku.grid.getCellRef(selection);

      //alert("prev="+sudoku.selection+" new="+selection);
      if (sudoku.selection == -1) {
        sudoku.selection = selection;
        //elem.setAttribute("style", "background-color: #FFFF00;");
      } else if (selection == sudoku.selection) {
        sudoku.selection = -1;
      } else {
        //var prev_id = '' + sudoku.selection;
        //prev_id = "c"+"00".substring(prev_id.length) + prev_id;
        //document.getElementById(prev_id).setAttribute("style", "background-color: white;");
        //elem.setAttribute("style", "background-color: #FFFF00;");

        var prev_cell = sudoku.grid.getCellRef(sudoku.selection);
        sudoku.selection = selection;
        sudoku.drawCell(prev_cell);
      }

      sudoku.drawCell(cell);
    }
  }

  // ---------------------------------------------------------------------------
  // Set up handling of number pad selections
  // ---------------------------------------------------------------------------

  for (var i = 1; i <= 9; i++) {
    var id = "inp" + i;

    document.getElementById(id).onclick = function() {
      if (sudoku.selection != -1) {
        var id = this.getAttribute("id");
        var bit = parseInt(id.substr(3)) - 1;
        var cell = sudoku.grid.getCellRef(sudoku.selection);
        cell.processBit(bit);
        sudoku.drawCell(cell);
        sudoku.reportValidity();
        sudoku.reportSolvedGrid();
      }
    }
  }

  document.getElementById("inpA").onclick = function() {
    if (sudoku.selection != -1) {
      var cell = sudoku.grid.getCellRef(sudoku.selection);
      if (!cell.isFixed()) {
        cell.setAllBits();
        cell.unfinaliseCell();
        sudoku.drawCell(cell);
        sudoku.reportValidity();
        sudoku.reportSolvedGrid();
      }
    }
  }

  document.getElementById("inpC").onclick = function() {
    if (sudoku.selection != -1) {
      var cell = sudoku.grid.getCellRef(sudoku.selection);
      if (!cell.isFixed()) {
        cell.unsetAllBits();
        cell.unfinaliseCell();
        sudoku.drawCell(cell);
        sudoku.reportValidity();
        sudoku.reportSolvedGrid();
      }
    }
  }

  document.getElementById("inpN").onclick = function() {
    if (sudoku.selection == -1) {
      //alert("Not yet implemented");
      sudoku.grid.initialise();
      sudoku.paint();
    }
  }

  // ---------------------------------------------------------------------------
  // Set up handling of Create New Puzzle button
  // ---------------------------------------------------------------------------

  document.getElementById("actNew").onclick = function() {
    sudoku.selection = -1;
    sudoku.locked = true;
    sudoku.creating = true;
    var level; // int
    do {
      level = sudoku.newPuzzle();
      sudoku.steps = [];
    //} while (sudoku.grid.solvedCellCount() > 22 );
    } while (level != sudoku.newLevel);

    //sudoku.valid = sudoku.grid.isValid();
    sudoku.saveGrid();
    position_element.innerHTML = (sudoku.historyIndex + 1) + "/" + sudoku.history.length;
    sudoku.creating = false;
    sudoku.locked = false;

    sudoku.paint();
  }

  // ---------------------------------------------------------------------------
  // Set up handling of Toggle Level button
  // ---------------------------------------------------------------------------

  document.getElementById("actLvl").onclick = function() {
    sudoku.newLevel = (sudoku.newLevel % 4) + 1;
    level_element.innerHTML = sudoku.levelToText(sudoku.newLevel);
  }

  // ---------------------------------------------------------------------------
  // Set up handling of Save Position button
  // ---------------------------------------------------------------------------

  document.getElementById("actSav").onclick = function() {
    sudoku.saveGrid();
    position_element.innerHTML = (sudoku.historyIndex + 1) + "/" + sudoku.history.length;
  }

  // ---------------------------------------------------------------------------
  // Set up handling of Solve button
  // ---------------------------------------------------------------------------

  document.getElementById("actSlv").onclick = function() {
    sudoku.selection = -1;

    sudoku.locked = true; // Lock user actions until further notice

    // Save grid if user made a change since last history
    if (!(new History(sudoku.grid, sudoku.level)).equals(sudoku.history[sudoku.historyIndex])) sudoku.saveGrid();

    // Store backup of current grid - will be reinstated after solving
    sudoku.backup = new History(sudoku.grid, -1);

    // Ensure cell bits are initialised before running any solving method
    sudoku.grid.initialise();

    // Count the number of values left to solve
    //alert(sudoku.grid.remaining());

    sudoku.solveAll();
    sudoku.doSteps();
    position_element.innerHTML = (sudoku.historyIndex + 1) + "/" + sudoku.history.length;

    sudoku.locked = false;
    sudoku.paint();
  }

  // ---------------------------------------------------------------------------
  // Set up handling of Clear Grid button
  // ---------------------------------------------------------------------------

  document.getElementById("actClr").onclick = function() {
    sudoku.selection = -1;
    sudoku.clearGrid();
    sudoku.paint();
  }

  // ---------------------------------------------------------------------------
  // Set up handling of Fix/Unfix Grid button
  // ---------------------------------------------------------------------------

  document.getElementById("actFix").onclick = function() {
    sudoku.selection = -1;
    var isFixed = false; // boolean
    for (var i = 0; i < 81; i++) {
      if (sudoku.grid.getCellRef(i).isFixed()) {
        isFixed = true;
        break;
      }
    }
    if (isFixed) {
      sudoku.grid.unfix();
    } else {
      sudoku.grid.fix();
    }
    sudoku.paint();
  }

  // ---------------------------------------------------------------------------
  // Set up handling of Previous Position button
  // ---------------------------------------------------------------------------

  document.getElementById("actPrv").onclick = function() {
    // Save grid if user made a change since last history
    if (!(new History(sudoku.grid, sudoku.level)).equals(sudoku.history[sudoku.historyIndex])) sudoku.saveGrid();

    sudoku.prevGrid();
    position_element.innerHTML = (sudoku.historyIndex + 1) + "/" + sudoku.history.length;
    sudoku.paint();
  }

  // ---------------------------------------------------------------------------
  // Set up handling of Next Position button
  // ---------------------------------------------------------------------------

  document.getElementById("actNxt").onclick = function() {
    // Save grid if user made a change since last history
    if (!(new History(sudoku.grid, sudoku.level)).equals(sudoku.history[sudoku.historyIndex])) sudoku.saveGrid();

    sudoku.nextGrid();
    position_element.innerHTML = (sudoku.historyIndex + 1) + "/" + sudoku.history.length;
    sudoku.paint();
  }




</script>

</html>
